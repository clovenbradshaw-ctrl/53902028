<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ledger Review | BU 53902028</title>
  <link rel="icon" type="image/png" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRZ9pSMhEiJ8s-1KcvC8Ls4JK7cVRYtU6LchA&s">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #111113;
      --bg-tertiary: #1a1a1d;
      --bg-card: #16161a;
      --border: #2a2a2e;
      --border-light: #3a3a3e;
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --accent: #f59e0b;
      --accent-dim: #b45309;
      --accent-glow: rgba(245, 158, 11, 0.15);
      --success: #10b981;
      --success-glow: rgba(16, 185, 129, 0.15);
      --warning: #f59e0b;
      --danger: #ef4444;
      --danger-glow: rgba(239, 68, 68, 0.15);
      --info: #3b82f6;
      --info-glow: rgba(59, 130, 246, 0.15);
      --font-sans: 'IBM Plex Sans', -apple-system, sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1800px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--bg-primary);
    }

    .logo-text {
      font-weight: 600;
      font-size: 1.1rem;
      letter-spacing: -0.02em;
    }

    .logo-sub {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }

    .header-stats {
      display: flex;
      gap: 2rem;
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent);
    }

    .stat-value.success { color: var(--success); }
    .stat-value.muted { color: var(--text-secondary); }

    .stat-label {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.65rem;
    }

    .header-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .nav-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border: 1px solid var(--accent);
      border-radius: 6px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .nav-link:hover {
      background: var(--accent);
      color: var(--bg-primary);
    }

    /* Main Layout */
    .main-container {
      display: flex;
      max-width: 1800px;
      margin: 0 auto;
      min-height: calc(100vh - 70px);
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(100vh - 70px);
      position: sticky;
      top: 70px;
    }

    .sidebar-section {
      margin-bottom: 1.5rem;
    }

    .sidebar-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      font-weight: 600;
    }

    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 1rem;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: var(--font-sans);
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      width: 18px;
      height: 18px;
    }

    /* Filter Groups */
    .filter-group {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }

    .filter-header {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .filter-header:hover {
      background: var(--bg-card);
    }

    .filter-header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-icon {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    .filter-name {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .filter-count {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
    }

    .filter-chevron {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .filter-group.open .filter-chevron {
      transform: rotate(180deg);
    }

    .filter-content {
      display: none;
      padding: 0.5rem;
      border-top: 1px solid var(--border);
      max-height: 200px;
      overflow-y: auto;
    }

    .filter-group.open .filter-content {
      display: block;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 0.8rem;
    }

    .filter-option:hover {
      background: var(--bg-card);
    }

    .filter-option.active {
      background: var(--accent-glow);
      color: var(--accent);
    }

    .filter-option-count {
      margin-left: auto;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .filter-checkbox {
      width: 14px;
      height: 14px;
      border: 1px solid var(--border-light);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .filter-option.active .filter-checkbox {
      background: var(--accent);
      border-color: var(--accent);
    }

    .filter-option.active .filter-checkbox::after {
      content: '\2713';
      font-size: 10px;
      color: var(--bg-primary);
    }

    .clear-filters {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      width: 100%;
      transition: all 0.2s;
    }

    .clear-filters:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    /* Content Area */
    .content {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .results-count {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .results-count strong {
      color: var(--text-primary);
    }

    /* Match Status Pills */
    .match-status-filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .match-pill {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .match-pill.all {
      background: var(--bg-tertiary);
      border-color: var(--border);
      color: var(--text-secondary);
    }

    .match-pill.matched {
      background: var(--success-glow);
      border-color: var(--success);
      color: var(--success);
    }

    .match-pill.unmatched {
      background: var(--bg-tertiary);
      border-color: var(--text-muted);
      color: var(--text-secondary);
    }

    .match-pill.active {
      box-shadow: 0 0 0 2px var(--bg-primary), 0 0 0 4px currentColor;
    }

    .match-pill:hover {
      filter: brightness(1.1);
    }

    /* Ledger Table */
    .ledger-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .ledger-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .ledger-table th.sortable {
      cursor: pointer;
      user-select: none;
    }

    .ledger-table th.sortable:hover {
      color: var(--text-primary);
    }

    .ledger-table th.sorted {
      color: var(--accent);
    }

    .ledger-table th .sort-icon {
      margin-left: 0.25rem;
      opacity: 0.5;
    }

    .ledger-table th.sorted .sort-icon {
      opacity: 1;
    }

    .ledger-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .ledger-table tr:hover {
      background: var(--bg-tertiary);
    }

    .ledger-table tr.has-scan {
      background: var(--success-glow);
    }

    .ledger-table tr.has-scan:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    .ledger-table tr.no-scan {
      background: transparent;
    }

    .ledger-table tr.no-scan:hover {
      background: var(--bg-tertiary);
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.matched {
      background: var(--success-glow);
      color: var(--success);
    }

    .status-badge.unmatched {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }

    .status-badge svg {
      width: 12px;
      height: 12px;
    }

    /* Match Details */
    .match-details {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .match-type {
      font-family: var(--font-mono);
      color: var(--text-secondary);
    }

    .match-confidence {
      color: var(--success);
    }

    /* Thumbnail */
    .thumb-cell {
      width: 60px;
    }

    .thumb-preview {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }

    .thumb-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumb-preview.no-image {
      color: var(--text-muted);
    }

    .thumb-preview svg {
      width: 20px;
      height: 20px;
    }

    /* Amount */
    .amount {
      font-family: var(--font-mono);
      font-weight: 500;
    }

    .amount.debit {
      color: var(--text-primary);
    }

    .amount.credit {
      color: var(--success);
    }

    /* Vendor Name */
    .vendor-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .invoice-num {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Date */
    .date-cell {
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    /* Category */
    .category-badge {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      background: var(--bg-tertiary);
      border-radius: 3px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    /* RS2025-974 funded row highlight */
    .ledger-table tr.rs2025-974 {
      background: rgba(245, 158, 11, 0.08);
    }

    .ledger-table tr.rs2025-974:hover {
      background: rgba(245, 158, 11, 0.15);
    }

    .rs974-badge {
      display: inline-block;
      background: var(--accent);
      color: var(--bg-primary);
      font-size: 0.55rem;
      font-weight: 600;
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 6px;
      font-family: var(--font-mono);
      vertical-align: middle;
    }

    /* Row Actions */
    .row-actions {
      opacity: 0;
      transition: opacity 0.2s;
    }

    .ledger-table tr:hover .row-actions {
      opacity: 1;
    }

    .action-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--bg-card);
      color: var(--accent);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      max-width: 1200px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      border: 1px solid var(--border);
    }

    .modal-image-section {
      flex: 1;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 400px;
    }

    .modal-image-section img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
    }

    .modal-no-image {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      color: var(--text-muted);
    }

    .modal-no-image svg {
      width: 64px;
      height: 64px;
      opacity: 0.3;
    }

    .modal-details-section {
      width: 400px;
      overflow-y: auto;
      border-left: 1px solid var(--border);
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .detail-section {
      margin-bottom: 1.5rem;
    }

    .detail-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .detail-section-title .source-badge {
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-size: 0.6rem;
    }

    .detail-section-title .source-badge.ledger {
      background: var(--accent-glow);
      color: var(--accent);
    }

    .detail-section-title .source-badge.ocr {
      background: var(--info-glow);
      color: var(--info);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--border);
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .detail-value {
      font-size: 0.85rem;
      text-align: right;
      max-width: 60%;
    }

    .detail-value.mono {
      font-family: var(--font-mono);
    }

    .detail-value.amount {
      color: var(--accent);
      font-weight: 600;
    }

    /* Summary Card */
    .summary-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .summary-card-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .summary-stats {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .summary-stat {
      text-align: center;
      padding: 0.75rem 0.5rem;
      background: var(--bg-primary);
      border-radius: 6px;
    }

    .summary-stat.total {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-tertiary) 100%);
      border: 1px solid var(--border);
    }

    .summary-stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      font-family: var(--font-mono);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .summary-stat-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .summary-stat.with-scan .summary-stat-value {
      color: var(--success);
    }

    .summary-stat.no-scan .summary-stat-value {
      color: var(--text-secondary);
    }

    /* Export Section */
    .export-section {
      margin-top: 1rem;
    }

    .export-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .export-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .export-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .export-btn:hover {
      background: var(--bg-card);
      border-color: var(--accent);
      color: var(--accent);
    }

    .export-btn svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .export-btn-label {
      flex: 1;
    }

    .export-btn-size {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">MN</div>
        <div>
          <div class="logo-text">Ledger Review</div>
          <div class="logo-sub">BU 53902028</div>
        </div>
      </div>
      <div class="header-stats">
        <div class="stat">
          <div class="stat-value" id="total-entries">-</div>
          <div class="stat-label">Total Entries</div>
        </div>
        <div class="stat">
          <div class="stat-value success" id="with-scan-count">-</div>
          <div class="stat-label">With Scan</div>
        </div>
        <div class="stat">
          <div class="stat-value muted" id="no-scan-count">-</div>
          <div class="stat-label">No Scan</div>
        </div>
      </div>
      <nav class="header-nav">
        <a href="index.html" class="nav-link">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          Invoice Viewer
        </a>
        <a href="vendor-profile.html" class="nav-link">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          Vendors
        </a>
        <a href="learn.html" class="nav-link">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4"/>
            <path d="M12 8h.01"/>
          </svg>
          Learn
        </a>
      </nav>
    </div>
  </header>

  <div class="main-container">
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Search</div>
        <div class="search-box">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.3-4.3"/>
          </svg>
          <input type="text" class="search-input" id="search-input" placeholder="Vendor, invoice #, amount...">
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Scan Status</div>
        <div class="match-status-filters">
          <div class="match-pill all active" data-status="all">All</div>
          <div class="match-pill matched" data-status="has-scan">Has Scan</div>
          <div class="match-pill unmatched" data-status="no-scan">No Scan</div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Filters</div>

        <div class="filter-group" id="filter-vendor">
          <div class="filter-header">
            <div class="filter-header-left">
              <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              <span class="filter-name">Vendor</span>
            </div>
            <span class="filter-count" id="filter-count-vendor">0</span>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m6 9 6 6 6-6"/>
            </svg>
          </div>
          <div class="filter-content" id="filter-options-vendor"></div>
        </div>

        <div class="filter-group" id="filter-category">
          <div class="filter-header">
            <div class="filter-header-left">
              <svg class="filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/>
              </svg>
              <span class="filter-name">Category</span>
            </div>
            <span class="filter-count" id="filter-count-category">0</span>
            <svg class="filter-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m6 9 6 6 6-6"/>
            </svg>
          </div>
          <div class="filter-content" id="filter-options-category"></div>
        </div>

        <button class="clear-filters" id="clear-filters">Clear All Filters</button>
      </div>

      <!-- Funding Chain / Resolutions -->
      <div class="sidebar-section">
        <div class="sidebar-title">Funding Chain</div>
        <div style="font-size: 0.75rem;">
          <a href="https://nashville.legistar.com/LegislationDetail.aspx?ID=5931612&GUID=A7A86D37-9FCC-4D05-88E4-2CEF9EBC82D4"
             target="_blank"
             style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 0.5rem; text-decoration: none; border: 1px solid var(--border); transition: border-color 0.2s;">
            <div style="color: var(--info); font-weight: 500;">RS2022-1860</div>
            <div style="color: var(--text-secondary); font-size: 0.7rem;">Original ARPA allocation</div>
          </a>

          <a href="https://nashville.legistar.com/LegislationDetail.aspx?ID=6706795&GUID=3911D2DC-BA71-4A2D-B975-458961A0A8A8"
             target="_blank"
             style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 0.5rem; text-decoration: none; border: 1px solid var(--border); transition: border-color 0.2s;">
            <div style="color: var(--info); font-weight: 500;">RS2024-490</div>
            <div style="color: var(--text-secondary); font-size: 0.7rem;">Reallocation to Strobel + Barnes</div>
          </a>

          <a href="https://nashville.legistar.com/LegislationDetail.aspx?ID=7093299&GUID=08251286-2A31-4D4D-AD28-2AC14F430F9D"
             target="_blank"
             style="display: block; padding: 0.5rem; background: var(--accent-glow); border-radius: 4px; margin-bottom: 0.5rem; text-decoration: none; border: 1px solid var(--accent-dim); transition: border-color 0.2s;">
            <div style="color: var(--accent); font-weight: 500;">RS2025-974</div>
            <div style="color: var(--text-secondary); font-size: 0.7rem;">Mobile Housing Navigation ($1.3M)</div>
          </a>

          <div style="font-size: 0.65rem; color: var(--text-muted); padding-top: 0.25rem;">
            <svg style="width: 10px; height: 10px; vertical-align: -1px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15,3 21,3 21,9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            Opens Nashville Legislation Portal
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="summary-card">
          <div class="summary-card-title">Amount Summary</div>
          <div class="summary-stats">
            <div class="summary-stat total">
              <div class="summary-stat-value" id="total-amount">$0</div>
              <div class="summary-stat-label">Total</div>
            </div>
            <div class="summary-stat with-scan">
              <div class="summary-stat-value" id="with-scan-amount">$0</div>
              <div class="summary-stat-label">With Scan</div>
            </div>
            <div class="summary-stat no-scan">
              <div class="summary-stat-value" id="no-scan-amount">$0</div>
              <div class="summary-stat-label">No Scan</div>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="export-section">
          <div class="export-title">Export Data (JSON)</div>
          <div class="export-buttons">
            <button class="export-btn" onclick="exportData('ledger')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <span class="export-btn-label">Ledger Only</span>
              <span class="export-btn-size" id="ledger-count">-</span>
            </button>
            <button class="export-btn" onclick="exportData('ocr')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <span class="export-btn-label">OCR/Scans Only</span>
              <span class="export-btn-size" id="ocr-count">-</span>
            </button>
            <button class="export-btn" onclick="exportData('matched')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <span class="export-btn-label">Matched (Ledger + Scan)</span>
              <span class="export-btn-size" id="matched-count">-</span>
            </button>
            <button class="export-btn" onclick="exportData('unmatched-ledger')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <span class="export-btn-label">Unmatched Ledger</span>
              <span class="export-btn-size" id="unmatched-ledger-count">-</span>
            </button>
            <button class="export-btn" onclick="exportData('unmatched-ocr')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <span class="export-btn-label">Unmatched OCR</span>
              <span class="export-btn-size" id="unmatched-ocr-count">-</span>
            </button>
            <button class="export-btn" onclick="exportData('all')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              <span class="export-btn-label">Full Merged Dataset</span>
              <span class="export-btn-size" id="all-count">-</span>
            </button>
          </div>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="toolbar">
        <div class="toolbar-left">
          <div class="results-count">
            Showing <strong id="results-shown">0</strong> of <strong id="results-total">0</strong> entries
          </div>
        </div>
      </div>

      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>Loading ledger data...</div>
      </div>

      <div id="table-container" style="display: none;">
        <table class="ledger-table">
          <thead>
            <tr>
              <th class="thumb-cell">Scan</th>
              <th class="sortable" data-sort="vendor">Vendor</th>
              <th class="sortable" data-sort="invoice_number">Invoice #</th>
              <th class="sortable" data-sort="invoice_date">Invoice Date</th>
              <th class="sortable" data-sort="amount">Amount</th>
              <th class="sortable" data-sort="category">Category</th>
            </tr>
          </thead>
          <tbody id="ledger-body"></tbody>
        </table>
      </div>

      <div id="empty-state" class="empty-state" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.3-4.3"/>
        </svg>
        <div>No entries match your filters</div>
      </div>
    </main>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-image-section" id="modal-image-section">
        <img id="modal-image" src="" alt="">
        <div class="modal-no-image" id="modal-no-image" style="display: none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="9" cy="9" r="2"/>
            <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
          </svg>
          <div>No scan available</div>
          <div style="font-size: 0.8rem;">This ledger entry does not have an associated invoice scan</div>
        </div>
      </div>
      <div class="modal-details-section">
        <div class="modal-header">
          <div class="modal-title" id="modal-title">Entry Details</div>
          <button class="modal-close" id="modal-close">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6 6 18"/>
              <path d="m6 6 12 12"/>
            </svg>
          </button>
        </div>
        <div class="modal-body" id="modal-body"></div>
      </div>
    </div>
  </div>

  <script>
    // ==================== STATE ====================
    let allEntries = [];
    let filteredEntries = [];
    let currentSort = { field: 'invoice_date', direction: 'desc' };
    let activeFilters = {
      search: '',
      status: 'all',
      vendor: [],
      category: []
    };

    // Store full data for exports
    let fullMergedData = null;
    let ledgerOnlyData = null;
    let ocrOnlyData = null;

    // ==================== UTILITIES ====================
    function formatNumber(num) {
      if (num === null || num === undefined) return '0.00';
      return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function debounce(fn, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }

    function getGoogleDriveLargeImageUrl(fileId) {
      if (!fileId) return null;
      return `https://lh3.googleusercontent.com/d/${fileId}=w800`;
    }

    // RS2025-974 funded vendors (Mobile Housing Navigation)
    const RS2025_974_VENDORS = [
      'community care fellowship',
      'nashville launch pad'
    ];

    function isRS2025974Vendor(vendorName) {
      if (!vendorName) return false;
      const lower = vendorName.toLowerCase();
      return RS2025_974_VENDORS.some(v => lower.includes(v));
    }

    // ==================== DATA LOADING ====================
    async function loadMergedData() {
      try {
        // Load all data files in parallel
        const [mergedResponse, ledgerResponse, ocrResponse] = await Promise.all([
          fetch('./merged-data.json'),
          fetch('./ledger-invoices.json'),
          fetch('./ocr-invoices.json')
        ]);

        const data = await mergedResponse.json();
        fullMergedData = data;

        // Load separate datasets
        try {
          ledgerOnlyData = await ledgerResponse.json();
        } catch (e) {
          console.warn('Could not load ledger-invoices.json:', e);
        }

        try {
          ocrOnlyData = await ocrResponse.json();
        } catch (e) {
          console.warn('Could not load ocr-invoices.json:', e);
        }

        const entries = [];

        // Process entries with scans (matched invoices)
        if (data.matched_invoices) {
          data.matched_invoices.forEach(inv => {
            entries.push({
              ...inv,
              _status: 'has-scan',
              _hasScan: true,
              _thumbnail: inv.ocr?.all_source_file_ids?.[0]
                ? getGoogleDriveLargeImageUrl(inv.ocr.all_source_file_ids[0])
                : null
            });
          });
        }

        // Process entries without scans (ledger-only)
        if (data.ledger_only?.invoices) {
          data.ledger_only.invoices.forEach(inv => {
            entries.push({
              ...inv,
              _status: 'no-scan',
              _hasScan: false
            });
          });
        }

        allEntries = entries;
        filteredEntries = [...entries];

        document.getElementById('loading').style.display = 'none';
        document.getElementById('table-container').style.display = 'block';

        updateStats();
        updateExportCounts();
        renderFilterOptions();
        applyFilters();

      } catch (error) {
        console.error('Failed to load merged data:', error);
        document.getElementById('loading').innerHTML = `
          <div style="color: var(--danger);">Failed to load data</div>
          <div style="font-size: 0.8rem; margin-top: 0.5rem;">${error.message}</div>
        `;
      }
    }

    // ==================== EXPORT FUNCTIONALITY ====================
    function updateExportCounts() {
      // Ledger only (all ledger entries from source file)
      const ledgerCount = ledgerOnlyData?.invoices?.length || 0;
      document.getElementById('ledger-count').textContent = ledgerCount + ' items';

      // OCR only (all OCR entries from source file)
      const ocrCount = ocrOnlyData?.invoices?.length || 0;
      document.getElementById('ocr-count').textContent = ocrCount + ' items';

      // Matched (ledger + scan)
      const matchedCount = fullMergedData?.matched_invoices?.length || 0;
      document.getElementById('matched-count').textContent = matchedCount + ' items';

      // Unmatched ledger
      const unmatchedLedgerCount = fullMergedData?.ledger_only?.invoices?.length || 0;
      document.getElementById('unmatched-ledger-count').textContent = unmatchedLedgerCount + ' items';

      // Unmatched OCR
      const unmatchedOcrCount = fullMergedData?.ocr_only?.invoices?.length || 0;
      document.getElementById('unmatched-ocr-count').textContent = unmatchedOcrCount + ' items';

      // All (full merged)
      const totalCount = matchedCount + unmatchedLedgerCount + unmatchedOcrCount;
      document.getElementById('all-count').textContent = totalCount + ' items';
    }

    function exportData(type) {
      let data, filename;

      switch(type) {
        case 'ledger':
          data = ledgerOnlyData;
          filename = 'bu53902028-ledger-only.json';
          break;
        case 'ocr':
          data = ocrOnlyData;
          filename = 'bu53902028-ocr-scans-only.json';
          break;
        case 'matched':
          data = {
            export_type: 'matched_invoices',
            export_date: new Date().toISOString(),
            count: fullMergedData?.matched_invoices?.length || 0,
            invoices: fullMergedData?.matched_invoices || []
          };
          filename = 'bu53902028-matched-invoices.json';
          break;
        case 'unmatched-ledger':
          data = {
            export_type: 'unmatched_ledger',
            export_date: new Date().toISOString(),
            count: fullMergedData?.ledger_only?.invoices?.length || 0,
            invoices: fullMergedData?.ledger_only?.invoices || []
          };
          filename = 'bu53902028-unmatched-ledger.json';
          break;
        case 'unmatched-ocr':
          data = {
            export_type: 'unmatched_ocr',
            export_date: new Date().toISOString(),
            count: fullMergedData?.ocr_only?.invoices?.length || 0,
            invoices: fullMergedData?.ocr_only?.invoices || []
          };
          filename = 'bu53902028-unmatched-ocr.json';
          break;
        case 'all':
          data = fullMergedData;
          filename = 'bu53902028-full-merged-data.json';
          break;
        default:
          console.error('Unknown export type:', type);
          return;
      }

      if (!data) {
        alert('Data not available for export. Please wait for data to load.');
        return;
      }

      // Create and trigger download
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ==================== STATS ====================
    function updateStats() {
      const withScan = allEntries.filter(e => e._hasScan);
      const noScan = allEntries.filter(e => !e._hasScan);

      document.getElementById('total-entries').textContent = allEntries.length;
      document.getElementById('with-scan-count').textContent = withScan.length;
      document.getElementById('no-scan-count').textContent = noScan.length;

      const totalAmount = allEntries.reduce((sum, e) => sum + (e.unified?.amount || e.ledger?.amount || 0), 0);
      const withScanAmount = withScan.reduce((sum, e) => sum + (e.unified?.amount || 0), 0);
      const noScanAmount = noScan.reduce((sum, e) => sum + (e.unified?.amount || e.ledger?.amount || 0), 0);

      document.getElementById('total-amount').textContent = '$' + formatNumber(totalAmount);
      document.getElementById('with-scan-amount').textContent = '$' + formatNumber(withScanAmount);
      document.getElementById('no-scan-amount').textContent = '$' + formatNumber(noScanAmount);
    }

    // ==================== FILTERS ====================
    function renderFilterOptions() {
      const filters = {
        vendor: {},
        category: {}
      };

      allEntries.forEach(entry => {
        const vendor = entry.unified?.vendor_name || entry.ledger?.vendor_name || 'Unknown';
        filters.vendor[vendor] = (filters.vendor[vendor] || 0) + 1;

        const category = entry.unified?.category || entry.ledger?.object_account_descr || 'Unknown';
        filters.category[category] = (filters.category[category] || 0) + 1;
      });

      renderFilterGroup('vendor', filters.vendor, activeFilters.vendor);
      renderFilterGroup('category', filters.category, activeFilters.category);
    }

    function renderFilterGroup(type, options, activeOptions) {
      const container = document.getElementById(`filter-options-${type}`);
      const countEl = document.getElementById(`filter-count-${type}`);
      const sortedKeys = Object.keys(options).sort((a, b) => options[b] - options[a]);

      countEl.textContent = sortedKeys.length;

      container.innerHTML = sortedKeys.map(key => `
        <div class="filter-option ${activeOptions.includes(key) ? 'active' : ''}" data-value="${escapeHtml(key)}">
          <div class="filter-checkbox"></div>
          <span>${escapeHtml(key)}</span>
          <span class="filter-option-count">${options[key]}</span>
        </div>
      `).join('');

      container.querySelectorAll('.filter-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const value = opt.dataset.value;
          const filterKey = type === 'match-type' ? 'matchType' : type;
          const idx = activeFilters[filterKey].indexOf(value);
          if (idx > -1) {
            activeFilters[filterKey].splice(idx, 1);
            opt.classList.remove('active');
          } else {
            activeFilters[filterKey].push(value);
            opt.classList.add('active');
          }
          applyFilters();
        });
      });
    }

    function applyFilters() {
      filteredEntries = allEntries.filter(entry => {
        // Scan status filter
        if (activeFilters.status === 'has-scan' && !entry._hasScan) {
          return false;
        }
        if (activeFilters.status === 'no-scan' && entry._hasScan) {
          return false;
        }

        // Search filter
        if (activeFilters.search) {
          const search = activeFilters.search.toLowerCase();
          const vendor = (entry.unified?.vendor_name || entry.ledger?.vendor_name || '').toLowerCase();
          const invoiceNum = (entry.unified?.invoice_number || entry.ledger?.invoice_number || '').toLowerCase();
          const amount = String(entry.unified?.amount || entry.ledger?.amount || '');

          if (!vendor.includes(search) && !invoiceNum.includes(search) && !amount.includes(search)) {
            return false;
          }
        }

        // Vendor filter
        if (activeFilters.vendor.length > 0) {
          const vendor = entry.unified?.vendor_name || entry.ledger?.vendor_name || 'Unknown';
          if (!activeFilters.vendor.includes(vendor)) return false;
        }

        // Category filter
        if (activeFilters.category.length > 0) {
          const category = entry.unified?.category || entry.ledger?.object_account_descr || 'Unknown';
          if (!activeFilters.category.includes(category)) return false;
        }

        return true;
      });

      sortEntries();
      renderTable();
      updateResultsCount();
    }

    function sortEntries() {
      const { field, direction } = currentSort;
      const mult = direction === 'asc' ? 1 : -1;

      filteredEntries.sort((a, b) => {
        let aVal, bVal;

        switch (field) {
          case 'vendor':
            aVal = a.unified?.vendor_name || a.ledger?.vendor_name || '';
            bVal = b.unified?.vendor_name || b.ledger?.vendor_name || '';
            break;
          case 'invoice_number':
            aVal = a.unified?.invoice_number || a.ledger?.invoice_number || '';
            bVal = b.unified?.invoice_number || b.ledger?.invoice_number || '';
            break;
          case 'invoice_date':
            aVal = a.unified?.invoice_date || a.ledger?.invoice_date || '';
            bVal = b.unified?.invoice_date || b.ledger?.invoice_date || '';
            break;
          case 'amount':
            aVal = a.unified?.amount || a.ledger?.amount || 0;
            bVal = b.unified?.amount || b.ledger?.amount || 0;
            return (aVal - bVal) * mult;
          case 'category':
            aVal = a.unified?.category || a.ledger?.object_account_descr || '';
            bVal = b.unified?.category || b.ledger?.object_account_descr || '';
            break;
          default:
            return 0;
        }

        return String(aVal).localeCompare(String(bVal)) * mult;
      });
    }

    function updateResultsCount() {
      document.getElementById('results-shown').textContent = filteredEntries.length;
      document.getElementById('results-total').textContent = allEntries.length;

      const tableContainer = document.getElementById('table-container');
      const emptyState = document.getElementById('empty-state');

      if (filteredEntries.length === 0) {
        tableContainer.style.display = 'none';
        emptyState.style.display = 'block';
      } else {
        tableContainer.style.display = 'block';
        emptyState.style.display = 'none';
      }
    }

    // ==================== RENDERING ====================
    function renderTable() {
      const tbody = document.getElementById('ledger-body');

      tbody.innerHTML = filteredEntries.map((entry, idx) => {
        const ledger = entry.ledger || {};
        const unified = entry.unified || {};

        const vendor = unified.vendor_name || ledger.vendor_name || 'Unknown';
        const invoiceNum = unified.invoice_number || ledger.invoice_number || 'N/A';
        const invoiceDate = unified.invoice_date || ledger.invoice_date || '-';
        const amount = unified.amount || ledger.amount || 0;
        const category = unified.category || ledger.object_account_descr || '-';
        const isCredit = ledger.credit > 0;
        const isRS974 = isRS2025974Vendor(vendor);

        return `
          <tr class="${entry._hasScan ? 'has-scan' : 'no-scan'}${isRS974 ? ' rs2025-974' : ''}" data-index="${idx}">
            <td class="thumb-cell">
              <div class="thumb-preview ${entry._thumbnail ? '' : 'no-image'}">
                ${entry._thumbnail
                  ? `<img src="${entry._thumbnail}" alt="" loading="lazy">`
                  : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="9" cy="9" r="2"/>
                      <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                    </svg>`
                }
              </div>
            </td>
            <td>
              <div class="vendor-name">${escapeHtml(vendor)}${isRS974 ? '<span class="rs974-badge">RS2025-974</span>' : ''}</div>
            </td>
            <td>
              <span class="invoice-num">${escapeHtml(invoiceNum)}</span>
            </td>
            <td class="date-cell">${invoiceDate}</td>
            <td>
              <span class="amount ${isCredit ? 'credit' : 'debit'}">
                ${isCredit ? '-' : ''}$${formatNumber(Math.abs(amount))}
              </span>
            </td>
            <td>
              <span class="category-badge">${escapeHtml(category)}</span>
            </td>
          </tr>
        `;
      }).join('');

      // Add click handlers for rows
      tbody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', () => {
          const idx = parseInt(row.dataset.index);
          openModal(filteredEntries[idx]);
        });
        row.style.cursor = 'pointer';
      });
    }

    // ==================== MODAL ====================
    function openModal(entry) {
      const overlay = document.getElementById('modal-overlay');
      const imageSection = document.getElementById('modal-image-section');
      const modalImage = document.getElementById('modal-image');
      const noImage = document.getElementById('modal-no-image');
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');

      const ledger = entry.ledger || {};
      const ocr = entry.ocr || {};
      const unified = entry.unified || {};
      const dataSources = entry._data_sources || {};

      modalTitle.textContent = unified.vendor_name || ledger.vendor_name || 'Entry Details';

      // Handle image
      if (entry._thumbnail) {
        modalImage.src = entry._thumbnail;
        modalImage.style.display = 'block';
        noImage.style.display = 'none';
      } else {
        modalImage.style.display = 'none';
        noImage.style.display = 'flex';
      }

      // Build details
      let html = '';

      // Ledger Data Section
      html += `
        <div class="detail-section">
          <div class="detail-section-title">
            Ledger Data
            <span class="source-badge ledger">SOURCE</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Document Type</span>
            <span class="detail-value">${ledger.document_type || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Document #</span>
            <span class="detail-value mono">${ledger.document_number || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Invoice #</span>
            <span class="detail-value mono">${ledger.invoice_number || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Vendor</span>
            <span class="detail-value">${ledger.vendor_name || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Vendor ID</span>
            <span class="detail-value mono">${ledger.vendor_id || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Invoice Date</span>
            <span class="detail-value">${ledger.invoice_date || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Payment Date</span>
            <span class="detail-value">${ledger.payment_date || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">GL Date</span>
            <span class="detail-value">${ledger.gl_date || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Amount</span>
            <span class="detail-value amount">$${formatNumber(ledger.amount || 0)}</span>
          </div>
          ${ledger.debit ? `
          <div class="detail-row">
            <span class="detail-label">Debit</span>
            <span class="detail-value">$${formatNumber(ledger.debit)}</span>
          </div>
          ` : ''}
          ${ledger.credit ? `
          <div class="detail-row">
            <span class="detail-label">Credit</span>
            <span class="detail-value" style="color: var(--success)">$${formatNumber(ledger.credit)}</span>
          </div>
          ` : ''}
          <div class="detail-row">
            <span class="detail-label">Object Account</span>
            <span class="detail-value">${ledger.object_account_descr || ledger.object_account || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Business Unit</span>
            <span class="detail-value mono">${ledger.business_unit || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Fund</span>
            <span class="detail-value mono">${ledger.fund || '-'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Batch</span>
            <span class="detail-value mono" style="font-size: 0.7rem">${ledger.batch_number || '-'}</span>
          </div>
          ${ledger.explanation ? `
          <div class="detail-row">
            <span class="detail-label">Explanation</span>
            <span class="detail-value" style="font-size: 0.75rem">${ledger.explanation}</span>
          </div>
          ` : ''}
        </div>
      `;

      // Scan Data Section (if has scan)
      if (entry._hasScan && ocr) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">
              Scan Data
              <span class="source-badge ocr">FROM SCAN</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Invoice Type</span>
              <span class="detail-value">${ocr.meta_invoice_type || '-'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">OCR Confidence</span>
              <span class="detail-value">${ocr.meta_confidence ? (ocr.meta_confidence * 100).toFixed(0) + '%' : '-'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Source Page</span>
              <span class="detail-value mono">${ocr.meta_source_page || '-'}</span>
            </div>
            ${ocr.invoice_total ? `
            <div class="detail-row">
              <span class="detail-label">Invoice Total (OCR)</span>
              <span class="detail-value">$${formatNumber(ocr.invoice_total)}</span>
            </div>
            ` : ''}
            ${ocr.processor_name ? `
            <div class="detail-row">
              <span class="detail-label">Processor</span>
              <span class="detail-value">${ocr.processor_name}</span>
            </div>
            ` : ''}
            ${ocr.vendor_phone ? `
            <div class="detail-row">
              <span class="detail-label">Vendor Phone</span>
              <span class="detail-value">${ocr.vendor_phone}</span>
            </div>
            ` : ''}
            ${ocr.vendor_email ? `
            <div class="detail-row">
              <span class="detail-label">Vendor Email</span>
              <span class="detail-value" style="font-size: 0.75rem">${ocr.vendor_email}</span>
            </div>
            ` : ''}
          </div>
        `;

        // Line Items
        if (ocr.line_items && ocr.line_items.length > 0) {
          html += `
            <div class="detail-section">
              <div class="detail-section-title">Line Items (${ocr.line_items.length})</div>
              <div style="max-height: 200px; overflow-y: auto;">
                <table style="width: 100%; font-size: 0.7rem; border-collapse: collapse;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                      <th style="text-align: left; padding: 4px;">Description</th>
                      <th style="text-align: right; padding: 4px;">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${ocr.line_items.slice(0, 10).map(item => `
                      <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 4px;">${escapeHtml(item.description || '-')}</td>
                        <td style="text-align: right; padding: 4px;">$${formatNumber(item.amount || 0)}</td>
                      </tr>
                    `).join('')}
                    ${ocr.line_items.length > 10 ? `
                      <tr>
                        <td colspan="2" style="padding: 4px; color: var(--text-muted);">...and ${ocr.line_items.length - 10} more</td>
                      </tr>
                    ` : ''}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        // Employee Names
        if (ocr.employee_names && ocr.employee_names.length > 0) {
          html += `
            <div class="detail-section">
              <div class="detail-section-title">Employee Names</div>
              <div style="font-size: 0.8rem; color: var(--text-secondary);">
                ${ocr.employee_names.join(', ')}
              </div>
            </div>
          `;
        }
      }

      modalBody.innerHTML = html;
      overlay.classList.add('open');
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('open');
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener('DOMContentLoaded', () => {
      // Load data
      loadMergedData();

      // Search
      document.getElementById('search-input').addEventListener('input', debounce((e) => {
        activeFilters.search = e.target.value;
        applyFilters();
      }, 300));

      // Match status pills
      document.querySelectorAll('.match-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          document.querySelectorAll('.match-pill').forEach(p => p.classList.remove('active'));
          pill.classList.add('active');
          activeFilters.status = pill.dataset.status;
          applyFilters();
        });
      });

      // Filter group toggles
      document.querySelectorAll('.filter-group .filter-header').forEach(header => {
        header.addEventListener('click', () => {
          header.parentElement.classList.toggle('open');
        });
      });

      // Clear filters
      document.getElementById('clear-filters').addEventListener('click', () => {
        activeFilters = {
          search: '',
          status: 'all',
          vendor: [],
          category: []
        };
        document.getElementById('search-input').value = '';
        document.querySelectorAll('.match-pill').forEach(p => p.classList.remove('active'));
        document.querySelector('.match-pill.all').classList.add('active');
        renderFilterOptions();
        applyFilters();
      });

      // Sort headers
      document.querySelectorAll('.ledger-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const field = th.dataset.sort;
          if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            currentSort.field = field;
            currentSort.direction = 'asc';
          }

          document.querySelectorAll('.ledger-table th.sortable').forEach(h => {
            h.classList.remove('sorted');
          });
          th.classList.add('sorted');

          applyFilters();
        });
      });

      // Modal close
      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'modal-overlay') closeModal();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });
    });
  </script>
</body>
</html>
